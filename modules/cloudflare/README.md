# Cloudflare 隧道管理模块

本模块集成了 Cloudflare Tunnel 的核心功能，为 TAV-X 提供安全、稳定的内网穿透能力，支持 Termux 及主流 Linux 发行版。

## 🌟 核心特性

- **一键部署**：自动适配架构安装最新版 `cloudflared`。
- **双模式支持**：
  - **⚡ 快速暴露 (Quick Tunnel)**：无需登录，生成随机 `.trycloudflare.com` 域名。
  - **🚀 固定隧道 (Named Tunnel)**：支持绑定自定义域名，配置持久化。
- **智能映射管理**：支持多域名映射（Ingress Rules）的增删改查。
- **自动化 DNS**：集成 Cloudflare API，实现域名记录的自动添加与清理。
- **孤儿清理**：自动扫描并清理指向已失效隧道的无效 DNS 记录。

## 🌐 获取免费域名

如果你还没有自己的域名，可以使用以下平台获取免费域名：
- **注册地址**：[DigitalPlat Domain](https://dash.domain.digitalplat.org/)

**简要流程：**
1.  **注册账号**：在该平台注册并登录。
2.  **申请域名**：选择可用的免费后缀进行申请。
3.  **接入 Cloudflare**：
    -   在 Cloudflare 控制面板点击 **Add a Site**。
    -   输入你申请到的域名。
    -   **修改 NS 记录**：将免费域名提供商处的 NameServers 修改为 Cloudflare 提供的地址。
4.  **等待生效**：DNS 生效后即可开始下方的快速上手流程。

> 📘 **详细教程**：关于域名注册及托管到 Cloudflare 的保姆级流程，请参考 [Nodeloc 社区教程](https://www.nodeloc.com/t/topic/41595)。

## 🛠️ 快速上手

### 1. 登录授权
在执行脚本授权前，**请务必先完成预登录**，否则手机端浏览器可能会在登录后丢失授权页面。

**操作步骤：**

1.  **浏览器预登录**：
    -   手动打开浏览器，访问 [Cloudflare Dashboard](https://dash.cloudflare.com/)。
    -   **完成账号登录**，直到看到域名列表或控制面板。
2.  **回到 TAV-X 脚本**：
    -   在 Cloudflare 菜单选择 **🔐 Tunnel 登录授权**。
3.  **点击授权链接**：
    -   脚本会生成授权 URL 并尝试跳转。
    -   由于你已经在浏览器登录过，页面会直接显示“选择域名”界面。
4.  **完成授权**：
    -   点击选择要绑定的域名，点击 **Authorize**。
5.  **确认返回**：
    -   看到网页提示 `Success` 后，回到脚本，等待系统提示 `登录成功`。

> 💡 **关键点**：如果先点击脚本链接再登录，Cloudflare 往往会卡在登录后的主页，不会自动回到授权页。

### 2. 临时内网穿透
如果你只是临时测试一个本地服务：
- 选择 **⚡ 临时快速暴露**
- 输入本地服务端口（默认 8000）
- 获取生成的公网地址即可。
- 此功能极不稳定，且部分地区被阻断，不建议长期使用。

### 3. 创建固定域名隧道
如果你希望长期拥有一个固定的访问地址：
1. 选择 **🚀 启动/管理固定隧道** -> **➕ 创建新隧道**。
2. 为隧道起名并按照引导绑定你的自定义域名。
3. 系统将自动处理 DNS 路由，并启动后台服务。

## 🔑 进阶功能：API Token

为了获得更好的自动化体验，建议配置 API Token：
1. 前往 [Cloudflare Dashboard](https://dash.cloudflare.com/profile/api-tokens)。
2. 创建一个具有 **Zone.DNS:Edit** 权限的 Token。
3. 在模块菜单选择 **🔑 API Token 设置** 进行保存。

配置后，你可以使用 **🧹 扫描并清理孤儿 DNS** 功能，快速清理由于非正常操作留下的“残留”域名记录。

## 📂 文件结构

- `main.sh`: 模块核心管理逻辑。
- `api_utils.sh`: Cloudflare API 交互封装。
- `*.yml`: 各个命名隧道的独立配置文件。
- `logs/`: 记录各个隧道运行状态。

## ⚠️ 注意事项

- 在 Termux 下使用时，请确保已授予外部存储权限以获得更好的兼容性。
- 修改域名映射后，脚本会自动重启对应的隧道进程以应用更改。
- 卸载/重置模块会抹除本地凭证，但建议在卸载前先手动停止并删除云端隧道资源。
