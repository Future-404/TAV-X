#!/bin/bash
# TAV-X Bootstrapper & Migrator (Universal)

# --- 1. æ™ºèƒ½å®šä½çœŸå®è·¯å¾„ ---
SOURCE=${BASH_SOURCE[0]}
while [ -L "$SOURCE" ]; do
  DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )
  SOURCE=$(readlink "$SOURCE")
  [[ $SOURCE != /* ]] && SOURCE=$DIR/$SOURCE
done
export TAVX_DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )

# --- 2. æ ¸å¿ƒæ ¡éªŒä¸å¯åŠ¨ ---
CORE_FILE="$TAVX_DIR/core/main.sh"

if [ -f "$CORE_FILE" ]; then
    # âœ… å®Œæ•´æ€§æ ¡éªŒé€šè¿‡ï¼Œå¯åŠ¨ v2.0
    chmod +x "$CORE_FILE" "$TAVX_DIR"/core/*.sh "$TAVX_DIR"/modules/*.sh 2>/dev/null
    exec bash "$CORE_FILE"
else
    # ğŸš¨ æ•‘æ´æ¨¡å¼ (é’ˆå¯¹ V1 è€ç”¨æˆ·æˆ–æŸåç¯å¢ƒ)
    clear
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    CYAN='\033[0;36m'
    NC='\033[0m'

    echo -e "${RED}"
    cat << "EOF"
â–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•
â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘
â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â–‘â–ˆâ–ˆâ•‘â–‘â–‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–‘â–‘
â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
â–‘â•šâ•â•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â–‘â–‘â–‘â–‘â•šâ•â•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â•šâ•â•â•šâ•â•â–‘â–‘â•šâ•â•â•šâ•â•â•â•â•â•â–‘â•šâ•â•â•â•â•â•â•
EOF
    echo -e "${NC}"
    echo -e "${YELLOW}>>> æ£€æµ‹åˆ° TAV-X æ ¸å¿ƒæ–‡ä»¶ç¼ºå¤± æˆ– ç‰ˆæœ¬è·¨åº¦è¿‡å¤§ã€‚${NC}"
    echo -e "${CYAN}è¿™é€šå¸¸æ˜¯å› ä¸ºæ‚¨åˆšåˆšä» v1.x ç‰ˆæœ¬å‡çº§åˆ°äº† v2.0 æ¶æ„ã€‚${NC}"
    echo -e "v2.0 é‡‡ç”¨äº†å…¨æ–°çš„æ¨¡å—åŒ–è®¾è®¡ï¼Œéœ€è¦é‡æ–°éƒ¨ç½²æ ¸å¿ƒç¯å¢ƒã€‚"
    echo ""
    echo -e "${GREEN}ä¸ç”¨æ‹…å¿ƒï¼Œæ‚¨çš„é…’é¦†æ•°æ® (SillyTavern/data) æ˜¯å®‰å…¨çš„ã€‚${NC}"
    echo -e "æˆ‘ä»¬å³å°†ä¸ºæ‚¨è‡ªåŠ¨æ‹‰å– v2.0 å®Œæ•´æ ¸å¿ƒ..."
    echo ""
    echo -e "æŒ‰ ${RED}å›è½¦é”® (Enter)${NC} å¼€å§‹è‡ªåŠ¨ä¿®å¤/å‡çº§..."
    read -r

    # è°ƒç”¨ Cloudflare å®‰è£…å™¨è¿›è¡Œæ— ç¼è¿ç§»
    # ä½¿ç”¨ curl -L ç¡®ä¿è·Ÿéšé‡å®šå‘
    INSTALLER_URL="https://tav-x.future404.qzz.io"
    
    echo -e "${YELLOW}>>> æ­£åœ¨è¿æ¥äº‘ç«¯å®‰è£…å™¨...${NC}"
    
    if command -v curl &> /dev/null; then
        curl -s -L "$INSTALLER_URL" | bash
    elif command -v wget &> /dev/null; then
        wget -qO- "$INSTALLER_URL" | bash
    else
        echo -e "${RED}âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° curl æˆ– wgetï¼Œæ— æ³•è‡ªåŠ¨ä¿®å¤ã€‚${NC}"
        echo -e "è¯·æ‰‹åŠ¨æ‰§è¡Œ: pkg install curl -y"
        exit 1
    fi
fi